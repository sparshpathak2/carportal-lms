// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// model Lead {
//   id              String       @id
//   dealerId        String? // reference dealerId from user-service
//   assignedToId    String? // reference userId from user-service
//   assignedToName  String? // reference username from user-service
//   name            String
//   email           String?
//   phone           String?
//   alternatePhone  String?
//   oldModel        String?
//   location        String?
//   city            String?
//   leadForwardedTo String[] // array of text
//   testDrive       Boolean      @default(false)
//   finance         Boolean      @default(false)
//   occupation      String?
//   budget          Int?
//   category        LeadCategory @default(COLD) // ðŸ‘ˆ NEW FIELD
//   source          String?

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   statusId     String?
//   status       LeadStatus?     @relation(fields: [statusId], references: [id])
//   lostReasonId String?
//   lostReason   LeadLostReason? @relation(fields: [lostReasonId], references: [id])

//   leadActivity LeadActivity[]
//   comments Comment[]
// }

// model Lead {
//   id             String  @id
//   dealerId       String? // reference dealerId from user-service
//   assignedToId   String? // reference userId from user-service
//   assignedToName String? // reference username from user-service

//   name            String
//   email           String?
//   phone           String?
//   alternatePhone  String?
//   oldModel        String?
//   location        String?
//   city            String?
//   leadForwardedTo String[] // array of text

//   testDrive  Boolean @default(false)
//   finance    Boolean @default(false)
//   occupation String?
//   budget     Int?

//   category LeadCategory @default(COLD)
//   source   String?

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   statusId String?
//   status   LeadStatus? @relation(fields: [statusId], references: [id])

//   lostReasonId String?
//   lostReason   LeadLostReason? @relation(fields: [lostReasonId], references: [id])

//   leadActivity LeadActivity[]
//   comments Comment[]

//   // ------------------------------------------------------------
//   // ðŸŽ¯ NEW FIELDS FOR FACEBOOK MARKETING HIERARCHY
//   // ------------------------------------------------------------
//   adId       String? // Facebook ad_id
//   adsetId    String? // Facebook adset_id
//   campaignId String? // Facebook campaign_id

//   adName       String? // Facebook ad name
//   adsetName    String? // Facebook ad set name
//   campaignName String? // Facebook campaign name
// }

model Customer {
  id             String   @id
  name           String
  email          String?
  phone          String
  alternatePhone String?
  city           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  leads Lead[] // One customer â†’ many leads
}

model Lead {
  id         String   @id
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  // dealerId       String?
  // assignedToId   String?
  // assignedToName String?

  // name            String
  // email           String?
  // phone           String?
  // alternatePhone  String?
  // location        String?
  // city            String?
  // leadForwardedTo String[]

  oldModel   String?
  testDrive  Boolean @default(false)
  finance    Boolean @default(false)
  occupation String?
  budget     Int?

  category LeadCategory @default(COLD)
  source   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  statusId String?
  status   LeadStatus? @relation(fields: [statusId], references: [id])

  lostReasonId String?
  lostReason   LeadLostReason? @relation(fields: [lostReasonId], references: [id])

  leadActivity LeadActivity[] @relation("LeadActivities")
  comments     Comment[]

  leadAssignments LeadAssignment[] // NEW â€” multiple dealer forwards
  analytics       LeadAnalytics? // NEW â€” 1:1 analytics tracking

  // ------------------------------------------------------------
  // ðŸŽ¯ NEW FIELDS FOR FACEBOOK MARKETING HIERARCHY
  // ------------------------------------------------------------
  adId       String? // Facebook ad_id
  adsetId    String? // Facebook adset_id
  campaignId String? // Facebook campaign_id

  adName       String? // Facebook ad name
  adsetName    String? // Facebook ad set name
  campaignName String? // Facebook campaign name
}

model LeadAnalytics {
  id     String @id @default(uuid())
  leadId String @unique
  lead   Lead   @relation(fields: [leadId], references: [id])

  internalUserId String?
  dealerId       String?

  firstDeliveredAt DateTime?
  firstConvertedAt DateTime?

  deliveredMetricFlag Boolean @default(false)
  convertedMetricFlag Boolean @default(false)

  currentStatusOrder  Int?
  lastStatusChangedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LeadStatus {
  id             String           @id
  name           String           @unique
  order          Int              @default(0)
  leads          Lead[]
  lostReasons    LeadLostReason[]
  LeadAssignment LeadAssignment[]
}

model LeadAssignment {
  id String @id @default(uuid())

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id])

  dealerId       String // from user-service dealer table
  assignedToId   String? // from user-service dealer table
  assignedToName String? // from user-service dealer table
  assignedById   String? // internal user ID who forwarded
  assignedByName String? // internal user ID who forwarded
  assignedAt     DateTime @default(now())

  isActive Boolean @default(true)

  // per-assignment metric flags
  deliveredMetricFlag Boolean @default(false)
  convertedMetricFlag Boolean @default(false)

  // dealer-specific activities
  leadActivities LeadActivity[] @relation("AssignmentActivities")

  // dealer-specific comments
  comments Comment[]

  // dealer-specific editable fields
  statusId String?
  status   LeadStatus? @relation(fields: [statusId], references: [id])

  lostReasonId String?
  lostReason   LeadLostReason? @relation(fields: [lostReasonId], references: [id])

  category LeadCategory?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Dynamic lost reasons linked to lead
model LeadLostReason {
  id       String     @id @default(uuid())
  name     String
  statusId String // link to LeadStatus
  status   LeadStatus @relation(fields: [statusId], references: [id])
  order    Int? // optional, explicitly define order

  leads           Lead[]
  leadAssignments LeadAssignment[]
}

model UserFilter {
  id        String   @id @default(uuid())
  userId    String
  type      String // e.g. "leads", "tickets", "customers"
  filters   Json
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@unique([userId, type]) // Each user has 1 filter per dashboard type
}

model Comment {
  id     String @id @default(uuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id])

  leadAssignmentId String? // ðŸ‘ˆ NEW
  leadAssignment   LeadAssignment? @relation(fields: [leadAssignmentId], references: [id])

  type          LeadActivityType
  description   String
  createdById   String?
  createdByName String?
  createdAt     DateTime         @default(now())
}

model LeadActivity {
  id String @id @default(uuid())

  leadId String
  lead   Lead   @relation("LeadActivities", fields: [leadId], references: [id], onDelete: Cascade)

  leadAssignmentId String?
  leadAssignment   LeadAssignment? @relation("AssignmentActivities", fields: [leadAssignmentId], references: [id])

  performedById   String?
  performedByName String?
  type            LeadActivityType
  description     String?

  oldStatus   String?
  newStatus   String?
  oldCategory String?
  newCategory String?
  oldReason   String?
  newReason   String?
  oldAssignee String?
  newAssignee String?

  dueDate   DateTime?
  completed Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task?
}

model Task {
  id             String       @id @default(uuid())
  leadActivityId String       @unique
  leadActivity   LeadActivity @relation(fields: [leadActivityId], references: [id])

  title          String
  assignedToId   String?
  assignedToName String?
  dueDate        DateTime
  completed      Boolean  @default(false)

  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id     String @id @default(uuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id])

  userId  String // who should receive notification
  message String
  read    Boolean @default(false)

  createdAt DateTime @default(now())
}

// model FbPageToken {
//   pageId    String   @id
//   token     String
//   expiresAt DateTime
// }

// model FbUserToken {
//   userId    String   @id
//   token     String
//   expiresAt DateTime
// }

// add to schema.prisma
model FbUserToken {
  id           String        @id @default(uuid())
  // identifies which business user or admin this token belongs to; optional
  // userId       String?
  token        String
  expiresAt    DateTime
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  fbPageTokens FbPageToken[]
}

model FbPageToken {
  id          String       @id @default(uuid())
  pageId      String       @unique
  pageName    String?
  accessToken String
  // keep reference to which user token was used to generate this
  userTokenId String?
  userToken   FbUserToken? @relation(fields: [userTokenId], references: [id])

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum LeadActivityType {
  LEAD_ADDED
  COMMENT // General text note
  CALL // Phone call
  MEETING // In-person meeting
  TEST_DRIVE // Test drive arranged/completed
  STATUS_UPDATE // Lead status changed
  CATEGORY_UPDATE // Lead Category changed
  ASSIGNMENT // Lead forwarded / reassigned
  CALLBACK // Callback scheduled
  FINANCE // Finance discussion/activity
  EMAIL // Email sent
  OTHER // Catch-all
}

enum LeadCategory {
  COLD
  WARM
  HOT
}
